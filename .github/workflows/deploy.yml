name: Build & Deploy to Azure

on:
  workflow_dispatch: # Manual trigger only — deploy when ready

permissions:
  id-token: write # Required for OIDC
  contents: read

env:
  RESOURCE_GROUP: cliniq-lite
  API_APP_NAME: cliniq-lite-api
  WEB_APP_NAME: cliniq-lite-web

jobs:
  # ── Detect which apps changed ──────────────────────────────
  changes:
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.filter.outputs.api }}
      web: ${{ steps.filter.outputs.web }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            api:
              - 'apps/api/**'
              - 'package.json'
              - 'package-lock.json'
            web:
              - 'apps/web/**'
              - 'package.json'
              - 'package-lock.json'

  # ── Build & Deploy API ─────────────────────────────────────
  deploy-api:
    needs: changes
    if: needs.changes.outputs.api == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to ACR
        run: az acr login --name ${{ secrets.ACR_NAME }}

      - name: Build & Push API image
        run: |
          IMAGE=${{ secrets.ACR_NAME }}.azurecr.io/cliniq-lite-api:${{ github.sha }}
          IMAGE_LATEST=${{ secrets.ACR_NAME }}.azurecr.io/cliniq-lite-api:latest
          docker build -f apps/api/Dockerfile -t $IMAGE -t $IMAGE_LATEST .
          docker push $IMAGE
          docker push $IMAGE_LATEST

      - name: Deploy API to Container App
        run: |
          az containerapp update \
            --name ${{ env.API_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ secrets.ACR_NAME }}.azurecr.io/cliniq-lite-api:${{ github.sha }} \
            --set-env-vars \
              "DATABASE_URL=${{ secrets.DATABASE_URL }}" \
              "DIRECT_URL=${{ secrets.DIRECT_URL }}" \
              "JWT_SECRET=${{ secrets.JWT_SECRET }}" \
              "API_PORT=4000" \
              "CORS_ORIGIN=${{ secrets.CORS_ORIGIN }}" \
              "NODE_ENV=production"

  # ── Build & Deploy Web ─────────────────────────────────────
  deploy-web:
    needs: changes
    if: needs.changes.outputs.web == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login to ACR
        run: az acr login --name ${{ secrets.ACR_NAME }}

      - name: Build & Push Web image
        run: |
          IMAGE=${{ secrets.ACR_NAME }}.azurecr.io/cliniq-lite-web:${{ github.sha }}
          IMAGE_LATEST=${{ secrets.ACR_NAME }}.azurecr.io/cliniq-lite-web:latest
          docker build -f apps/web/Dockerfile \
            --build-arg NEXT_PUBLIC_API_BASE_URL=${{ secrets.NEXT_PUBLIC_API_BASE_URL }} \
            -t $IMAGE -t $IMAGE_LATEST .
          docker push $IMAGE
          docker push $IMAGE_LATEST

      - name: Deploy Web to Container App
        run: |
          az containerapp update \
            --name ${{ env.WEB_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ secrets.ACR_NAME }}.azurecr.io/cliniq-lite-web:${{ github.sha }}
